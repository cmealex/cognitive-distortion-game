<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#3a7bd5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Cognitive Distortion Matcher</title>
    <link rel="stylesheet" href="therapy-game-css.css">
    <link rel="manifest" href="manifest.json">
    <script>
        // Error handler to filter out extension-related errors
        const originalConsoleError = console.error;
        console.error = function() {
            const args = Array.from(arguments);
            const errorMessage = args[0];
            
            // List of known extension-related files to ignore
            const ignoreFiles = [
                'debug.js',
                'browser-info.js',
                'block-css-value.js',
                'block-types.js',
                'icon-badge-periods.js',
                'message-types.js',
                'storage-service.js',
                'api.js',
                'helpers.js',
                'dialog.js',
                'overlay.js',
                'block-elements.js',
                'doc-helpers.js',
                'dom-changes-observer.js',
                'rule-parser.js',
                'doc-popup-helpers.js',
                'doc-start.js'
            ];

            // Check if the error is from an extension
            const isExtensionError = ignoreFiles.some(file => 
                errorMessage && errorMessage.toString().includes(file)
            );

            if (!isExtensionError) {
                originalConsoleError.apply(console, args);
            }
        };
    </script>
    <style>
        /* Prevent text selection on mobile */
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        /* Allow text selection in input fields */
        input {
            -webkit-user-select: text;
            user-select: text;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <div id="login-screen" class="screen">
            <h1>Cognitive Distortion PsyGame</h1>
            <div class="form-container">
  <h2>Login</h2>
  <form id="login-form">
    <div class="form-group">
      <label for="username">Username:</label>
      <input type="text" id="username" placeholder="Enter username" required />
    </div>
    <div class="form-group">
      <label for="password">Password:</label>
      <input type="password" id="password" placeholder="Enter password" required />
    </div>
    <button id="login-btn" type="submit">Login</button>
    <p id="login-error" class="error-message"></p>
  </form>

 
</div>


					</div>

        <!-- Admin Screen -->
        <div id="admin-screen" class="screen hidden">
            <h1>Admin Panel</h1>
			<div class="container1">
			  <button id="admin-logout-btn" class="logout-btn">Logout</button>
			</div>
			<style>
			  .container1 {
				display: flex;
				justify-content: flex-end;
			  }
			</style>

            <div class="admin-container">
			<h2>Create User</h2>
			<form id="create-user-form">
				<div class="form-group">
					<label for="new-username">Username:</label>
					<input type="text" id="new-username" placeholder="Enter new username">
				</div>
				<div class="form-group">
					<label for="new-password">Password:</label>
					<input type="password" id="new-password" placeholder="Enter new password">
				</div>
				<button id="create-user-btn" type="submit">Create User</button>
			</form>
			<div id="user-list">
				<h3>User Credentials</h3>
				<ul id="credentials-list"></ul>
			</div>
			</div>
        </div>
	

        <!-- Profile Setup Screen -->
        <div id="profile-screen" class="screen hidden">
    <h1>Setup Your Profile</h1>
    <div class="profile-container">
        <div class="form-group">
            <label for="nickname">Nickname:</label>
            <input type="text" id="nickname" placeholder="Choose a nickname">
        </div>
        <div class="avatar-selection">
            <h3>Select an Avatar</h3>
            <div class="avatar-grid">
                <!-- Pikachu -->
                <div class="avatar" data-avatar="1">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 160 160">
                        <circle cx="80" cy="80" r="70" fill="#ffeaa7" fill-opacity="0.7" />
                        <text x="80" y="25" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#333">PIKACHU</text>
                        <ellipse cx="80" cy="80" rx="40" ry="35" fill="#FFF000"/>
                        <path d="M60,50 L40,20 L60,45 Z" fill="#FFF000" stroke="#000" stroke-width="1"/>
                        <path d="M100,50 L120,20 L100,45 Z" fill="#FFF000" stroke="#000" stroke-width="1"/>
                        <path d="M40,20 L47,30 L52,22 Z" fill="#000"/>
                        <path d="M120,20 L113,30 L108,22 Z" fill="#000"/>
                        <circle cx="67" cy="70" r="4" fill="#000"/>
                        <circle cx="93" cy="70" r="4" fill="#000"/>
                        <path d="M73,85 C77,90 83,90 87,85" stroke="#000" stroke-width="1.5" fill="none"/>
                        <path d="M80,80 L62,77 L68,80 M80,80 L98,77 L92,80" stroke="#AA0000" stroke-width="1.5" fill="none"/>
                        <path d="M120,80 L140,65 L150,80 L140,95 Z" fill="#AA7700"/>
                        <path d="M110,80 L120,80 L140,65 L130,70 Z" fill="#FFF000"/>
                        <path d="M30,80 L40,65 L50,70 L40,95 Z" fill="#FFD700" stroke="#000" stroke-width="1"/>
                    </svg>
                </div>
                
                <!-- Snorlax -->
                <div class="avatar" data-avatar="2">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 160 160">
                        <circle cx="80" cy="80" r="70" fill="#74b9ff" fill-opacity="0.7" />
                        <text x="80" y="25" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#333">SNORLAX</text>
                        <ellipse cx="80" cy="90" rx="50" ry="40" fill="#6890F0"/>
                        <ellipse cx="80" cy="55" rx="25" ry="20" fill="#6890F0"/>
                        <line x1="68" y1="50" x2="77" y2="50" stroke="#000" stroke-width="2"/>
                        <line x1="83" y1="50" x2="92" y2="50" stroke="#000" stroke-width="2"/>
                        <path d="M73,58 C77,61 83,61 87,58" stroke="#000" stroke-width="1.5" fill="none"/>
                        <ellipse cx="80" cy="95" rx="35" ry="25" fill="#EEEEFF"/>
                        <text x="105" y="40" font-family="Arial" font-weight="bold" font-size="20" fill="#333">Z</text>
                        <text x="120" y="30" font-family="Arial" font-weight="bold" font-size="16" fill="#333">Z</text>
                        <text x="130" y="20" font-family="Arial" font-weight="bold" font-size="12" fill="#333">Z</text>
                    </svg>
                </div>
                
                <!-- Psyduck -->
                <div class="avatar" data-avatar="3">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 160 160">
                        <circle cx="80" cy="80" r="70" fill="#fab1a0" fill-opacity="0.7" />
                        <text x="80" y="25" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#333">PSYDUCK</text>
                        <ellipse cx="80" cy="90" rx="30" ry="35" fill="#FFD54F"/>
                        <ellipse cx="80" cy="60" rx="25" ry="30" fill="#FFD54F"/>
                        <path d="M80,65 L95,75 L80,80 L65,75 Z" fill="#FFB74D"/>
                        <ellipse cx="70" cy="55" rx="4" ry="6" fill="#fff"/>
                        <ellipse cx="90" cy="55" rx="4" ry="6" fill="#fff"/>
                        <circle cx="70" cy="55" r="2" fill="#000"/>
                        <circle cx="90" cy="55" r="2" fill="#000"/>
                        <ellipse cx="55" cy="60" rx="10" ry="7" fill="#FFD54F" transform="rotate(-20)"/>
                        <ellipse cx="105" cy="60" rx="10" ry="7" fill="#FFD54F" transform="rotate(20)"/>
                        <path d="M80,30 C86,30 92,33 92,40 C92,47 80,47 80,54 C80,61 92,61 92,68" stroke="#5D4037" stroke-width="2" fill="none"/>
                    </svg>
                </div>
                
                <!-- Jigglypuff -->
                <div class="avatar" data-avatar="4">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 160 160">
                        <circle cx="80" cy="80" r="70" fill="#fd79a8" fill-opacity="0.7" />
                        <text x="80" y="25" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#333">JIGGLYPUFF</text>
                        <circle cx="80" cy="80" r="40" fill="#FFA6C9"/>
                        <ellipse cx="65" cy="65" rx="7" ry="10" fill="#fff"/>
                        <ellipse cx="95" cy="65" rx="7" ry="10" fill="#fff"/>
                        <circle cx="65" cy="65" r="3" fill="#000"/>
                        <circle cx="95" cy="65" r="3" fill="#000"/>
                        <path d="M70,90 C77,96 83,96 90,90" stroke="#000" stroke-width="1.5" fill="none"/>
                        <ellipse cx="80" cy="35" rx="10" ry="7" fill="#FFA6C9" transform="rotate(-5)"/>
                        <rect x="110" y="75" width="3" height="25" fill="#333" rx="1"/>
                        <ellipse cx="111.5" y="72" rx="8" ry="6" fill="#333"/>
                        <path d="M40,65 L45,55 L50,58 L45,68 Z" fill="#333"/>
                        <line x1="50" y1="58" x2="53" y2="70" stroke="#333" stroke-width="1.5"/>
                        <path d="M30,85 L35,75 L40,78 L35,88 Z" fill="#333"/>
                        <line x1="40" y1="78" x2="43" y2="90" stroke="#333" stroke-width="1.5"/>
                    </svg>
                </div>
                
                <!-- Gengar -->
                <div class="avatar" data-avatar="5">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 160 160">
                        <circle cx="80" cy="80" r="70" fill="#a29bfe" fill-opacity="0.7" />
                        <text x="80" y="25" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#333">GENGAR</text>
                        <path d="M80,110 C40,110 35,65 80,55 C125,65 120,110 80,110 Z" fill="#663399"/>
                        <ellipse cx="65" cy="72" rx="10" ry="13" fill="#fff"/>
                        <ellipse cx="95" cy="72" rx="10" ry="13" fill="#fff"/>
                        <circle cx="65" cy="72" r="5" fill="#FF0000"/>
                        <circle cx="95" cy="72" r="5" fill="#FF0000"/>
                        <circle cx="65" cy="72" r="2" fill="#000"/>
                        <circle cx="95" cy="72" r="2" fill="#000"/>
                        <path d="M60,90 C70,100 90,100 100,90" stroke="#fff" stroke-width="2" fill="none"/>
                        <path d="M50,60 L52,55 L55,60" stroke="#663399" stroke-width="5" fill="none"/>
                        <path d="M70,55 L72,45 L74,55" stroke="#663399" stroke-width="5" fill="none"/>
                        <path d="M86,55 L88,45 L90,55" stroke="#663399" stroke-width="5" fill="none"/>
                        <path d="M105,60 L108,55 L110,60" stroke="#663399" stroke-width="5" fill="none"/>
                        <ellipse cx="80" cy="110" rx="30" ry="5" fill="#000" fill-opacity="0.3"/>
                    </svg>
                </div>
                
                <!-- Meowth -->
                <div class="avatar" data-avatar="6">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 160 160">
                        <circle cx="80" cy="80" r="70" fill="#ffeaa7" fill-opacity="0.7" />
                        <text x="80" y="25" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#333">MEOWTH</text>
                        <ellipse cx="80" cy="90" rx="25" ry="30" fill="#F5DEB3"/>
                        <circle cx="80" cy="60" r="25" fill="#F5DEB3"/>
                        <path d="M60,40 L50,20 L70,35 Z" fill="#F5DEB3" stroke="#000" stroke-width="1"/>
                        <path d="M100,40 L110,20 L90,35 Z" fill="#F5DEB3" stroke="#000" stroke-width="1"/>
                        <path d="M50,20 L55,30 L60,25 Z" fill="#000"/>
                        <path d="M110,20 L105,30 L100,25 Z" fill="#000"/>
                        <ellipse cx="70" cy="60" rx="3" ry="6" fill="#000"/>
                        <ellipse cx="90" cy="60" rx="3" ry="6" fill="#000"/>
                        <ellipse cx="80" cy="70" rx="5" ry="3" fill="#FF9999"/>
                        <path d="M80,70 L80,75 M68,75 C74,83 86,83 92,75" stroke="#000" stroke-width="1.5" fill="none"/>
                        <line x1="62" y1="65" x2="50" y2="63" stroke="#000" stroke-width="0.7"/>
                        <line x1="62" y1="70" x2="50" y2="70" stroke="#000" stroke-width="0.7"/>
                        <line x1="62" y1="75" x2="50" y2="77" stroke="#000" stroke-width="0.7"/>
                        <line x1="98" y1="65" x2="110" y2="63" stroke="#000" stroke-width="0.7"/>
                        <line x1="98" y1="70" x2="110" y2="70" stroke="#000" stroke-width="0.7"/>
                        <line x1="98" y1="75" x2="110" y2="77" stroke="#000" stroke-width="0.7"/>
                        <circle cx="80" cy="45" r="8" fill="#FFD700" stroke="#000" stroke-width="1"/>
                        <circle cx="40" cy="80" r="10" fill="#FFD700" stroke="#000" stroke-width="1"/>
                        <circle cx="35" cy="65" r="7" fill="#FFD700" stroke="#000" stroke-width="1"/>
                        <circle cx="45" cy="55" r="8" fill="#FFD700" stroke="#000" stroke-width="1"/>
                        <path d="M65,95 L50,77" stroke="#F5DEB3" stroke-width="5" fill="none"/>
                        <circle cx="48" cy="75" r="7" fill="#F5DEB3"/>
                    </svg>
                </div>
            </div>
        </div>
        <button id="save-profile-btn">Save Profile</button>
    </div>
</div>

        <!-- Level Selection Screen -->
        <div id="level-screen" class="screen hidden">
            <h1>Select a Level</h1>
		 <div id="user-info" style="display: none; text-align: right;">
			Logged in as: <b><span id="logged-in-username"></span></b>
		  </div>
			<div class="container1">
			  <button id="logout-btn" class="logout-btn">Logout</button>
			</div>
			<style>
			  .container1 {
				display: flex;
				justify-content: flex-end;
			  }
			</style>
            <div class="user-profile">
                <img id="profile-avatar" src="" alt="Your avatar">
                <span id="profile-nickname">Player</span>
            </div>
            <div class="level-container">
                <div class="level-grid" id="level-grid"></div>
            </div>
            <div class="leaderboard">
                <h2>Leaderboard</h2>
                <table id="leaderboard-table">
                    <thead>
                        <tr>
                            <th>Level</th>
                            <th>Player</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body"></tbody>
                </table>
            </div>
			
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="screen hidden">
            <div class="game-header">
                <div class="level-info">
                    <h2>Level <span id="current-level">1</span></h2>
                </div>
                <div class="timer">
                    <span id="time-left">60</span> seconds left
                </div>
                <div class="score">
                    <span id="score">0</span> / <span id="total-pairs">3</span> matched
                </div>
            </div>
            <div class="game-container">
                <div class="situation-panel">
                    <h3>Situations</h3>
                    <div id="situations-container" class="items-container"></div>
                </div>
                <div class="distortion-panel">
                    <h3>Cognitive Distortions</h3>
                    <div id="distortions-container" class="items-container"></div>
                </div>
            </div>
            <div class="game-footer">
                <button id="back-to-levels" class="secondary-btn">Back to Levels</button>
            </div>
        </div>

        <!-- Level Complete Screen -->
        <div id="level-complete" class="screen hidden">
            <h1>Level Complete!</h1>
            <div class="results-container">
                <p>You completed level <span id="completed-level">1</span>!</p>
                <p>Time used: <span id="time-used">0</span> seconds</p>
                <p>Score: <span id="final-score">0</span>/<span id="max-score">3</span></p>
                <div id="level-unlocked" class="hidden">
                    <p>You've unlocked level <span id="unlocked-level">2</span>!</p>
                </div>
            </div>
            <div class="button-group">
                <button id="retry-btn">Retry Level</button>
                <button id="next-level-btn">Next Level</button>
                <button id="return-levels-btn">Return to Levels</button>
            </div>
        </div>
    </div>

    <script src="game-db.js"></script>
    <script src="therapy-game-js.js"></script>
    <script>
        // Error handling for duplicate script loading
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            // Ignore errors from browser extensions
            if (url && url.includes('chrome-extension://')) {
                return true;
            }
            // Log other errors
            console.error('Error: ' + msg + '\nURL: ' + url + '\nLine: ' + lineNo + '\nColumn: ' + columnNo + '\nError object: ' + JSON.stringify(error));
            return false;
        };

        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Wait for database initialization
                await initDB();
                
                // Function to show/hide screens
                function showScreen(screenId) {
                    document.querySelectorAll('.screen').forEach(screen => {
                        screen.classList.add('hidden');
                    });
                    document.getElementById(screenId).classList.remove('hidden');
                    
                    // If showing level screen, update the grid and leaderboard
                    if (screenId === 'level-screen') {
                        renderLevelGrid();
                        renderLeaderboard();
                    }
                }

                // Function to update user list
                async function updateUserList() {
                    try {
                        const users = await gameDB.listUsers();
                        const credentialsList = document.getElementById('credentials-list');
                        credentialsList.innerHTML = '';
                        
                        users.forEach(user => {
                            const li = document.createElement('li');
                            li.textContent = `Username: ${user.username} (${user.isAdmin ? 'Admin' : 'User'})`;
                            credentialsList.appendChild(li);
                        });
                    } catch (error) {
                        console.error('Error updating user list:', error);
                    }
                }

                // Login form handling
                document.getElementById('login-form').addEventListener('submit', async function(event) {
                    event.preventDefault();
                    const username = document.getElementById('username').value.trim();
                    const password = document.getElementById('password').value.trim();

                    if (!username || !password) {
                        document.getElementById('login-error').textContent = 'Please fill in all fields.';
                        return;
                    }

                    try {
                        const user = await gameDB.getUser(username);
                        if (user && user.password === password) {
                            document.getElementById('login-error').textContent = '';
                            document.getElementById('logged-in-username').textContent = username;
                            document.getElementById('user-info').style.display = 'block';
                            
                            // Load user profile
                            const profile = await gameDB.getProfile(username);
                            if (profile) {
                                document.getElementById('profile-nickname').textContent = profile.nickname;
                                if (profile.avatar) {
                                    const avatarElement = document.querySelector(`.avatar[data-avatar="${profile.avatar}"]`);
                                    if (avatarElement) {
                                        const svgContent = avatarElement.querySelector('svg').outerHTML;
                                        document.getElementById('profile-avatar').src = 'data:image/svg+xml;base64,' + btoa(svgContent);
                                    }
                                }
                            } else {
                                // If no profile exists, show profile setup screen
                                showScreen('profile-screen');
                                return;
                            }
                            
                            // Show appropriate screen based on user type
                            if (user.isAdmin) {
                                showScreen('admin-screen');
                                updateUserList();
                            } else {
                                showScreen('level-screen');
                            }
                        } else {
                            document.getElementById('login-error').textContent = 'Invalid username or password.';
                        }
                    } catch (error) {
                        console.error('Login error:', error);
                        document.getElementById('login-error').textContent = 'An error occurred during login.';
                    }
                });

                // Create user form handling
                const createUserForm = document.getElementById('create-user-form');
                if (createUserForm) {
                    createUserForm.addEventListener('submit', async function(event) {
                        event.preventDefault();
                        
                        const username = this.querySelector('#new-username').value;
                        const password = this.querySelector('#new-password').value;
                        
                        if (!username || !password) {
                            alert('Please enter both username and password');
                            return;
                        }
                        
                        try {
                            await gameDB.addUser(username, password);
                            // Create a default profile for the new user
                            await gameDB.saveProfile(username, {
                                nickname: username,
                                avatar: '1' // Default to first avatar
                            });
                            alert('User created successfully!');
                            this.reset();
                            updateUserList();
                        } catch (error) {
                            console.error('Error creating user:', error);
                            alert(error.message || 'Error creating user. Please try again.');
                        }
                    });
                }

                // Logout buttons
                document.getElementById('logout-btn')?.addEventListener('click', function() {
                    showScreen('login-screen');
                });

                document.getElementById('admin-logout-btn')?.addEventListener('click', function() {
                    showScreen('login-screen');
                });

                // Avatar selection
                const avatars = document.querySelectorAll('.avatar');
                avatars.forEach(avatar => {
                    avatar.addEventListener('click', function() {
                        avatars.forEach(a => a.classList.remove('selected'));
                        this.classList.add('selected');
                    });
                });

                // Profile saving
                const saveProfileBtn = document.getElementById('save-profile-btn');
                if (saveProfileBtn) {
                    saveProfileBtn.addEventListener('click', async function() {
                        if (!validateProfile()) return;
                        
                        const username = document.getElementById('logged-in-username').textContent;
                        const nickname = document.getElementById('nickname').value;
                        const selectedAvatar = document.querySelector('.avatar.selected');
                        const avatarId = selectedAvatar.getAttribute('data-avatar');
                        
                        try {
                            await gameDB.saveProfile(username, {
                                nickname,
                                avatar: avatarId
                            });
                            
                            showScreen('level-screen');
                            // Update profile display
                            document.getElementById('profile-nickname').textContent = nickname;
                            const avatarElement = document.querySelector(`.avatar[data-avatar="${avatarId}"]`);
                            if (avatarElement) {
                                const svgContent = avatarElement.querySelector('svg').outerHTML;
                                document.getElementById('profile-avatar').src = 'data:image/svg+xml;base64,' + btoa(svgContent);
                            }
                        } catch (error) {
                            console.error('Error saving profile:', error);
                            alert('Error saving profile. Please try again.');
                        }
                    });
                }

                // Profile validation
                let alertShown = false;
                function validateProfile() {
                    if (alertShown) return false;
                    
                    const nickname = document.getElementById('nickname').value;
                    if (!nickname) {
                        alert('Please enter a nickname');
                        alertShown = true;
                        setTimeout(() => { alertShown = false; }, 100);
                        return false;
                    }
                    
                    const selectedAvatar = document.querySelector('.avatar.selected');
                    if (!selectedAvatar) {
                        alert('Please select an avatar');
                        alertShown = true;
                        setTimeout(() => { alertShown = false; }, 100);
                        return false;
                    }
                    
                    return true;
                }
            } catch (error) {
                console.error('Error initializing application:', error);
                alert('An error occurred. Please try again later.');
            }
        });
    </script>

<footer id="myFooter">
    <p>For more information about this page, click <a href="despre.html">here</a>.</p>
    <p>To see the technologies used, click <a href="tech-stack.html">here</a>.</p>
    <p>Implemented by Alex Simion - © Copyright 2025 - <a href="https://www.psyalexsimion.com/">www.psyalexsimion.com</a></p>
</footer>
<style>
    footer#myFooter {
        background-color: #3a7bd5;
        color: white;
        text-align: center;
        padding: 15px 10px;
        font-size: 14px;
        position: fixed;
        bottom: 0;
        width: 100%;
        left: 0;
    }
    footer#myFooter a {
        color: white;
        text-decoration: underline;
    }
</style>
</body>
</html>
